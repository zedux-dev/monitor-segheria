{"version":3,"file":"writeXlsxFileNode.js","names":["fs","path","os","Archive","generateWorkbookXml","generateWorkbookXmlRels","rels","contentTypes","generateSheets","writeXlsxFile","data","filePath","buffer","sheetName","sheet","sheetNames","sheets","schema","columns","headerStyle","getHeaderStyle","fontFamily","fontSize","orientation","stickyRowsCount","stickyColumnsCount","showGridLines","rightToLeft","dateFormat","archive","getSharedStringsXml","getStylesXml","createTempDirectory","root","createDirectory","join","xl","_rels","worksheetsPath","promises","writeFile","id","push","Promise","all","directory","append","write","removeDirectoryWithLegacyNodeVersionsSupport","streamToBuffer","contents","resolve","reject","error","mkdir","mkdtemp","tmpdir","directoryPath","rm","removeDirectory","removeDirectoryLegacySync","recursive","force","childNames","readdirSync","childName","childPath","stats","statSync","isDirectory","unlinkSync","rmdirSync","stream","chunks","on","chunk","Buffer","concat"],"sources":["../../source/write/writeXlsxFileNode.js"],"sourcesContent":["import fs from 'fs'\r\nimport path from 'path'\r\nimport os from 'os'\r\n\r\nimport Archive from './archive.js'\r\n\r\nimport generateWorkbookXml from './statics/workbook.xml.js'\r\nimport generateWorkbookXmlRels from './statics/workbook.xml.rels.js'\r\nimport rels from './statics/rels.js'\r\nimport contentTypes from './statics/[Content_Types].xml.js'\r\n\r\nimport { generateSheets } from './writeXlsxFile.common.js'\r\n\r\nexport default async function writeXlsxFile(data, {\r\n\tfilePath,\r\n\tbuffer,\r\n\tsheet: sheetName,\r\n\tsheets: sheetNames,\r\n\tschema,\r\n\tcolumns,\r\n\theaderStyle,\r\n\tgetHeaderStyle,\r\n\tfontFamily,\r\n\tfontSize,\r\n\torientation,\r\n\tstickyRowsCount,\r\n\tstickyColumnsCount,\r\n\tshowGridLines,\r\n\trightToLeft,\r\n\tdateFormat\r\n} = {}) {\r\n\tconst archive = new Archive(filePath)\r\n\r\n\tconst {\r\n\t\tsheets,\r\n\t\tgetSharedStringsXml,\r\n\t\tgetStylesXml\r\n\t} = generateSheets({\r\n\t\tdata,\r\n\t\tsheetName,\r\n\t\tsheetNames,\r\n\t\tschema,\r\n\t\tcolumns,\r\n\t\theaderStyle,\r\n\t\tgetHeaderStyle,\r\n\t\tfontFamily,\r\n\t\tfontSize,\r\n\t\torientation,\r\n\t\tstickyRowsCount,\r\n\t\tstickyColumnsCount,\r\n\t\tshowGridLines,\r\n\t\trightToLeft,\r\n\t\tdateFormat\r\n\t})\r\n\r\n\t// There doesn't seem to be a way to just append a file into a subdirectory\r\n\t// in `archiver` library, hence using a hacky temporary directory workaround.\r\n\t// https://www.npmjs.com/package/archiver\r\n\tconst root = await createTempDirectory()\r\n\tconst xl = await createDirectory(path.join(root, 'xl'))\r\n\tconst _rels = await createDirectory(path.join(xl, '_rels'))\r\n\tconst worksheetsPath = await createDirectory(path.join(xl, 'worksheets'))\r\n\r\n\tconst promises = [\r\n\t\twriteFile(path.join(_rels, 'workbook.xml.rels'), generateWorkbookXmlRels({ sheets })),\r\n\t\twriteFile(path.join(xl, 'workbook.xml'), generateWorkbookXml({ sheets, stickyRowsCount, stickyColumnsCount })),\r\n\t\twriteFile(path.join(xl, 'styles.xml'), getStylesXml()),\r\n\t\twriteFile(path.join(xl, 'sharedStrings.xml'), getSharedStringsXml())\r\n\t]\r\n\r\n\tfor (const { id, data } of sheets) {\r\n\t\tpromises.push(writeFile(path.join(worksheetsPath, `sheet${id}.xml`), data))\r\n\t}\r\n\r\n\tawait Promise.all(promises)\r\n\r\n\tarchive.directory(xl, 'xl')\r\n\tarchive.append(rels, '_rels/.rels')\r\n\tarchive.append(contentTypes, '[Content_Types].xml')\r\n\r\n\tif (filePath) {\r\n\t\tawait archive.write()\r\n\t\tawait removeDirectoryWithLegacyNodeVersionsSupport(root)\r\n\t} else if (buffer) {\r\n\t\treturn streamToBuffer(archive.write())\r\n\t} else {\r\n\t\treturn archive.write()\r\n\t}\r\n}\r\n\r\nfunction writeFile(path, contents) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.writeFile(path, contents, 'utf-8', (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve()\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction createDirectory(path) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.mkdir(path, (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(path)\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction createTempDirectory() {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.mkdtemp(path.join(os.tmpdir(), 'write-excel-file-'), (error, directoryPath) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve(directoryPath)\r\n\t\t})\r\n\t})\r\n}\r\n\r\nfunction removeDirectoryWithLegacyNodeVersionsSupport(path) {\r\n\tif (fs.rm) {\r\n\t\treturn removeDirectory(path)\r\n\t} else {\r\n\t\tremoveDirectoryLegacySync(path)\r\n  \treturn Promise.resolve()\r\n\t}\r\n}\r\n\r\n// `fs.rm()` is available in Node.js since `14.14.0`.\r\nfunction removeDirectory(path) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tfs.rm(path, { recursive: true, force: true }, (error) => {\r\n\t\t\tif (error) {\r\n\t\t\t\treturn reject(error)\r\n\t\t\t}\r\n\t\t\tresolve()\r\n\t\t})\r\n\t})\r\n}\r\n\r\n// For Node.js versions below `14.14.0`.\r\nfunction removeDirectoryLegacySync(directoryPath) {\r\n  const childNames = fs.readdirSync(directoryPath)\r\n  for (const childName of childNames) {\r\n    const childPath = path.join(directoryPath, childName)\r\n    const stats = fs.statSync(childPath)\r\n    if (childPath === '.' || childPath === '..') {\r\n      // Skip.\r\n    } else if (stats.isDirectory()) {\r\n      // Remove subdirectory recursively.\r\n      removeDirectoryLegacySync(childPath)\r\n    } else {\r\n      // Remove file.\r\n      fs.unlinkSync(childPath)\r\n    }\r\n  }\r\n  fs.rmdirSync(directoryPath)\r\n}\r\n\r\n// https://stackoverflow.com/a/67729663\r\nfunction streamToBuffer(stream) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tconst chunks = []\r\n\t\tstream.on('data', (chunk) => chunks.push(chunk))\r\n\t\tstream.on('end', () => resolve(Buffer.concat(chunks)))\r\n\t\tstream.on('error', reject)\r\n\t})\r\n}"],"mappings":"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"}